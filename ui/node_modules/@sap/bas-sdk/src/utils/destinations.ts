import { URL } from "url";
import { addJwtHeader } from "../apis/headers-helper";

export const ENV_H2O_URL = "H2O_URL";

/**
 * Represents the destination type.
 */
export type DestinationType = "HTTP";

/**
 * Represents the proxy types supported by the Connectivity service.
 */
export type ProxyType = "Internet" | "OnPremise";

/**
 * Represents the different authentication values for access control.
 */
export const AuthenticationType = {
  NoAuthentication: "NoAuthentication",
  BasicAuthentication: "BasicAuthentication",
  OAuth2ClientCredentials: "OAuth2ClientCredentials",
  OAuth2UserTokenExchange: "OAuth2UserTokenExchange"
} as const;

/**
 * Represents the different authentication types for access control.
 */
export type AuthenticationType = (typeof AuthenticationType)[keyof typeof AuthenticationType];

/**
 * Transform AuthenticationType into a set of OAuth properties, if available.
 */
export const authenticationTypeToProperties: Record<AuthenticationType, (credentials: Credentials) => OAuth2ClientCredentials | OAuth2UserTokenExchange | undefined> = {
  [AuthenticationType.OAuth2UserTokenExchange]: (credentials) => credentials.oauth2UserTokenExchange,
  [AuthenticationType.OAuth2ClientCredentials]: (credentials) => credentials.oauth2ClientCredentials,
  [AuthenticationType.NoAuthentication]: () => undefined,
  [AuthenticationType.BasicAuthentication]: () => undefined
}

export interface FlatDestination {
  Name: string;
  Type: string;
  Authentication: string;
  ProxyType: string;
  Description?: string;

  WebIDEEnabled: string;
  "HTML5.DynamicDestination"?: string;
  "HTML5.Timeout"?: string;

  "sap-client"?: string;
  WebIDEUsage?: string;
  WebIDEAdditionalData?: string;
  "product.name"?: string;

  User?: string;
  Password?: string;

  tokenServiceURL?: string;
  tokenServiceURLType?: string;
  tokenServiceUser?: string;
  tokenServicePassword?: string;
  clientSecret?: string;
  clientId?: string;

  "URL.headers.ApiKey"?: string;
  applicationID?: string;
  apiBusinessHubEnterpriseURL?: string;

  "com.sap.catalog.propagate.credential"?: string;
  "x-system-type"?: string;
  "x-correlation-id"?: string;
  "x-system-id"?: string;
}

export interface ResponseDestination extends FlatDestination {
  Host: string;
}

export interface AnswerDestination extends FlatDestination {
  URL: string;
}

export interface BasicAuthentication {
  userName: string;
  userPassword: string;
}

export type TokenServiceURLType = 'Dedicated' | 'Common';

export interface OAuth2ClientCredentials {
  clientId: string;
  clientSecret: string;
  tokenServiceURL: string;
  tokenServiceURLType: TokenServiceURLType;
  tokenServiceUser?: string;
  tokenServicePassword?: string;
}

export interface OAuth2UserTokenExchange
    extends Omit<
        OAuth2ClientCredentials,
        "tokenServiceUser" & "tokenServicePassword"
    > {}

export interface Credentials {
  authentication: AuthenticationType;
  basicAuthentication?: BasicAuthentication;
  oauth2ClientCredentials?: OAuth2ClientCredentials;
  oauth2UserTokenExchange?: OAuth2UserTokenExchange;
}

export interface BASProperties {
  usage?: string;
  additionalData?: string;
  sapClient?: string;
  productName?: string;
  apiKey?: string;
  applicationID?: string;
  apiBusinessHubEnterpriseURL?: string;
  // Developer Hub related properties
  comSapCatalogPropagateCredential?: string;
  xSystemType?: string;
  xCorrelationId?: string;
  xSystemId?: string;
  html5DynamicDestination?: string;
  html5Timeout?: string;
}

export interface DestinationBaseInfo {
  name: string;
  type: DestinationType;
  credentials: Credentials;
  proxyType: ProxyType;
  description?: string;
  basProperties?: BASProperties;
}

export interface DestinationListInfo extends DestinationBaseInfo {
  host: string;
}
export interface DestinationInfo extends DestinationBaseInfo {
  url: URL;
}

export function strToDestinationType(typeName: string): DestinationType {
  const typeNameArr: DestinationType[] = ["HTTP"];
  const destinationType = typeNameArr.find((element) => element === typeName);
  if (!destinationType) {
    throw new Error(`unknown ${typeName} destination type`);
  }
  return destinationType;
}

export function strToTokenServiceUrlType(typeName: string): TokenServiceURLType {
  const typeNameArr: TokenServiceURLType[] = ["Dedicated", "Common"];
  const tokenServiceUrlType = typeNameArr.find((element) => element === typeName);
  if (!tokenServiceUrlType) {
    throw new Error(`unknown ${typeName} token service url type`);
  }
  return tokenServiceUrlType;
}

export function strToAuthenticationType(
  authenticationName: string,
): AuthenticationType {
  const authenticationNameArr: AuthenticationType[] = [
    "NoAuthentication",
    "BasicAuthentication",
    "OAuth2ClientCredentials",
    "OAuth2UserTokenExchange",
  ];
  const authenticationType = authenticationNameArr.find(
    (element) => element === authenticationName,
  );
  if (!authenticationType) {
    throw new Error(`unknown ${authenticationName} authentication type`);
  }
  return authenticationType;
}

export function strToProxyType(proxyTypeName: string): ProxyType {
  const proxyTypeNameArr: ProxyType[] = ["Internet", "OnPremise"];
  const proxyType = proxyTypeNameArr.find(
    (element) => element === proxyTypeName,
  );
  if (!proxyType) {
    throw new Error(`unknown ${proxyTypeName} proxy type`);
  }
  return proxyType;
}

export function strToBoolean(text: string): boolean {
  if (!text) {
    return false;
  }
  return text.toLocaleLowerCase() === "true";
}

function toCredentials(flatDestinations: FlatDestination): Credentials {
  const credentials: Credentials = {
    authentication: strToAuthenticationType(flatDestinations.Authentication),
  };
  // Currently we are expose the credentials from the list
  return credentials;
}
const sapClient = "sap-client";
const productName = "product.name";
const apiKey = "URL.headers.ApiKey";
const applicationId = "applicationID";
const dynamicDestination = "HTML5.DynamicDestination";
const html5Timeout = "HTML5.Timeout";
const sapPropagateCredential = "com.sap.catalog.propagate.credential";
const xSystemType = "x-system-type";
const xCorrelationId = "x-correlation-id";
const xSystemId = "x-system-id";

function extractBASProperties(
  flatDestination: FlatDestination,
): BASProperties | undefined {
  const basProperties: BASProperties = {};
  if (flatDestination.WebIDEAdditionalData) {
    basProperties.additionalData = flatDestination.WebIDEAdditionalData;
  }

  if (flatDestination.WebIDEUsage) {
    basProperties.usage = flatDestination.WebIDEUsage;
  }

  if (flatDestination[dynamicDestination]) {
    basProperties.html5DynamicDestination = flatDestination[dynamicDestination];
  }

  if (flatDestination[html5Timeout]) {
    basProperties.html5Timeout = flatDestination[html5Timeout];
  }

  if (flatDestination[sapClient]) {
    basProperties.sapClient = flatDestination[sapClient];
  }

  if (flatDestination[productName]) {
    basProperties.productName = flatDestination[productName];
  }

  if (flatDestination[apiKey]) {
    basProperties.apiKey = flatDestination[apiKey];
  }

  if (flatDestination[applicationId]) {
    basProperties.applicationID = flatDestination[applicationId];
  }

  if (flatDestination.apiBusinessHubEnterpriseURL) {
    basProperties.apiBusinessHubEnterpriseURL =
      flatDestination.apiBusinessHubEnterpriseURL;
  }

  if (flatDestination[sapPropagateCredential]) {
    basProperties.comSapCatalogPropagateCredential = flatDestination[sapPropagateCredential];
  }

  if (flatDestination[xSystemType]) {
    basProperties.xSystemType = flatDestination[xSystemType];
  }

  if (flatDestination[xCorrelationId]) {
    basProperties.xCorrelationId = flatDestination[xCorrelationId];
  }

  if (flatDestination[xSystemId]) {
    basProperties.xSystemId = flatDestination[xSystemId];
  }

  return Object.keys(basProperties).length === 0 ? undefined : basProperties;
}

//Transform the destination format to flat destination
export function destinationInfoToAnswerDestination(
  destinationInfo: DestinationInfo,
): AnswerDestination {
  const answerDestination: AnswerDestination = {
    Name: destinationInfo.name,
    Type: "HTTP",
    Authentication: destinationInfo.credentials.authentication,
    ProxyType: destinationInfo.proxyType,
    URL: destinationInfo.url.toString(),
    WebIDEEnabled: "true",
  };

  if (destinationInfo.credentials.authentication === "BasicAuthentication") {
    if (!destinationInfo.credentials.basicAuthentication) {
      throw new Error("Missing user and password for Basic Authentication");
    }
    answerDestination.User =
        destinationInfo.credentials.basicAuthentication.userName;
    answerDestination.Password =
        destinationInfo.credentials.basicAuthentication.userPassword;
  }
  if ((["OAuth2ClientCredentials", "OAuth2UserTokenExchange"]).includes(destinationInfo.credentials.authentication)) {
    const oauthProperties = getOAuthProperties(destinationInfo.credentials);
    answerDestination.tokenServiceURL = oauthProperties.tokenServiceURL;
    answerDestination.tokenServiceURLType = oauthProperties.tokenServiceURLType;
    answerDestination.clientId = oauthProperties.clientId;
    answerDestination.clientSecret = oauthProperties.clientSecret;
    answerDestination.tokenServiceUser = oauthProperties.tokenServiceUser;
    answerDestination.tokenServicePassword =
      oauthProperties.tokenServicePassword;
  }

  if (destinationInfo.description) {
    answerDestination.Description = destinationInfo.description;
  }

  if (destinationInfo.basProperties?.additionalData) {
    answerDestination.WebIDEAdditionalData =
      destinationInfo.basProperties.additionalData;
  }

  if (destinationInfo.basProperties?.usage) {
    answerDestination.WebIDEUsage = String(destinationInfo.basProperties.usage);
  }

  if (destinationInfo.basProperties?.sapClient) {
    if (destinationInfo.basProperties.sapClient.length != 3) {
      throw new Error(
        `${sapClient} "${destinationInfo.basProperties.sapClient}" property length must equal 3.`,
      );
    }
    answerDestination[sapClient] = destinationInfo.basProperties.sapClient;
  }

  if (destinationInfo.basProperties?.productName) {
    answerDestination[productName] = destinationInfo.basProperties.productName;
  }

  if (destinationInfo.basProperties?.apiKey) {
    answerDestination[apiKey] = destinationInfo.basProperties.apiKey;
  }

  if (destinationInfo.basProperties?.applicationID) {
    answerDestination[applicationId] =
      destinationInfo.basProperties.applicationID;
  }

  if (destinationInfo.basProperties?.apiBusinessHubEnterpriseURL) {
    answerDestination.apiBusinessHubEnterpriseURL =
      destinationInfo.basProperties.apiBusinessHubEnterpriseURL;
  }

  if (destinationInfo.basProperties?.html5DynamicDestination !== undefined) {
    answerDestination["HTML5.DynamicDestination"] =
      destinationInfo.basProperties.html5DynamicDestination;
  } else {
    answerDestination["HTML5.DynamicDestination"] = "true";
  }

  if (destinationInfo.basProperties?.html5Timeout) {
    answerDestination[html5Timeout] =
      destinationInfo.basProperties.html5Timeout;
  }

  if (destinationInfo.basProperties?.comSapCatalogPropagateCredential) {
    answerDestination[sapPropagateCredential] =
      destinationInfo.basProperties.comSapCatalogPropagateCredential;
  }

  if (destinationInfo.basProperties?.xSystemType) {
    answerDestination[xSystemType] =
      destinationInfo.basProperties.xSystemType;
  }

  if (destinationInfo.basProperties?.xSystemId) {
    answerDestination[xSystemId] =
      destinationInfo.basProperties.xSystemId;
  }

  if (destinationInfo.basProperties?.xCorrelationId) {
    answerDestination[xCorrelationId] =
      destinationInfo.basProperties.xCorrelationId;
  }

  return answerDestination;
}

// Transform the response destination to the real destination format
export function flatDestinationToDestinationBaseInfo(
  flatDestination: FlatDestination,
): DestinationBaseInfo {
  const destination: DestinationBaseInfo = {
    name: flatDestination.Name,
    type: strToDestinationType(flatDestination.Type),
    credentials: toCredentials(flatDestination),
    proxyType: strToProxyType(flatDestination.ProxyType),
  };

  if (flatDestination.Description) {
    destination.description = flatDestination.Description;
  }

  const basProperties = extractBASProperties(flatDestination);
  if (basProperties) {
    destination.basProperties = basProperties;
  }
  return destination;
}

// Transform the response destination to the destination list infor that add the host member
export function responseDestinationToDestinationListInfo(
  responseDestination: ResponseDestination,
): DestinationListInfo {
  const detinationBaseInfo =
    flatDestinationToDestinationBaseInfo(responseDestination);
  const destinationListInfo: DestinationListInfo = {
    ...detinationBaseInfo,
    host: responseDestination.Host,
  };
  return destinationListInfo;
}
//get destination headers for all the request from teh server
export function getDestinationHeaders(): Record<string, string> {
  const headers: Record<string, string> = {
    "Content-Type": "application/json",
    "User-Agent": "Bas",
  };
  return addJwtHeader(headers);
}

/**
 * Return the OAuth properties for a given Authentication.
 *
 * @param credentials
 * @returns - OAuth2ClientCredentials | OAuth2UserTokenExchange
 */
function getOAuthProperties(credentials: Credentials): OAuth2ClientCredentials | OAuth2UserTokenExchange {
  const oauthProperties = authenticationTypeToProperties[credentials.authentication](credentials);
  if (!oauthProperties) {
    throw new Error(`Missing credentials for ${credentials.authentication}`);
  }
  return oauthProperties;
}
